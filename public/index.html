<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    <style type="text/css">
      /*html { height: 100%; width: 100%}
      body { height: 100%; width: 100%; margin: 0; padding: 0 }
      #mapcanvas { height: 100%; width: 100%}*/
/*      .ui-content-sp {
        padding: 0px;
      }*/
      .show-hide {
        display:none;
      }

      .item {
          margin: 0px 2px 2px 2px;
          padding: 5px;
      }

      .rounded {
          border-radius: 8px 8px 8px 8px;
      }

      .dark {
          background: none repeat scroll 0 0 #2A3333;
      }

      .ui-collapsible-heading {
        display: block;
        font-size: 16px;
        /*margin: 0 -15px;*/
        padding: 2px;
        position: relative;
      }

      .ui-collapsible-content {
        background-image: none;
       /* border-left-width: 0;
        border-right-width: 0;*/
        border-top: 0 none;
        /*display: block;*/
        margin: -2px 2px 2px 2px;
        padding: 10px 15px;
      }

      .ui-collapsible-inset .ui-collapsible-content {
          border-left-width: 1px;
          border-right-width: 1px;
          margin: -2px 2px 2px 2px;
      }
    </style>
    
    
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <script type="text/javascript" src="jquery.ui.map.js"></script>
    <script type="text/javascript" src="jquery.ui.map.extensions.js"></script>
    <script type="text/javascript" >
      var lat;
      var lng;
      var markers = [];

      $(function() {
          loadData();

          $("#refresh_btn").click(function() {
            loadData();
            location.reload(true);
          });

          $("#mean").change(function() {
              var meanOption = $(this).val();
              var numbers = []

              if(meanOption == 'bus') {
                  numbers = [519, 116, 422, 521, 131]
              }

              if(meanOption == 'tram') {
                  numbers = [12, 33, 17, 18, 22, 25]
              }

              var options = '';
              for(var i = 0; i < numbers.length; i++) {
                  options += '<option value="' + numbers[i] + '">' + numbers[i] + '</option>';
              }
              
              $("#numbers-div").show();
              $("#numbers").html(options);
          });

          $("#numbers").change(function() {
              $("#add-inspection-div").show();
          });

          $("#add-inspection").click(function() {
            var form = $(this).closest("form");
            var transportType = form.find('select[name="mean"]').val();
            var number = form.find('select[name="numbers"]').val();

            $.post('/events', { "event" : { "transport_type" : transportType, "lat" : lat, "lng" : lng, "line_number": number }}, function(json) {

              loadData();
              location.reload(true);
            });
          });
        });

        function loadData() {
          $('#map_canvas').gmap().bind('init', function(evt, map) {

            $('#map_canvas').gmap('getCurrentPosition', function(position, status) {
              if ( status === 'OK' ) {
                lat = position.coords.latitude;
                lng = position.coords.longitude;

                var clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                $('#map_canvas').gmap('addMarker', {'position': clientPosition, 'bounds': true});

                $.getJSON("/events?lat=" + lat + "&lng=" + lng, function(json) {
                    var event_lat = json[0].event.lat;
                    var event_lng = json[0].event.lng;

                    $.each(json, function(i, event) {
                      console.log("----" + json[i].event.lat)
                      $('#map_canvas').gmap('addMarker', { 
                        'position': new google.maps.LatLng(json[i].event.lat, json[i].event.lng), 
                        'bounds': true,
                        'icon': 'images/bus.png'
                      }).click(function() {
                        var d = new Date(json[i].event.created_at);
                        var contentString = '<font size=\'2\'>Kontrola biletów:</font></br>' +
                                            ''+ convertTransportMean(json[i].event.transport_type) + 
                                            ', linia nr ' + json[i].event.line_number + '</br>' +
                                            'Godz. <b>' + timeToHMS(d) + '</b>';

                        $('#map_canvas').gmap('openInfoWindow', { 'content': contentString }, this);
                      });

                    });
                });
              }
            }); 
          });
        }

        function dateToYMD(date) {
            var d = date.getDate();
            var m = date.getMonth() + 1;
            var y = date.getFullYear();

            return '' + y + '-' + (m <= 9 ? '0' + m : m) + '-' + (d <= 9 ? '0' + d : d);
        }

        function timeToHMS(date) {
          var h = date.getHours();
          var m = date.getMinutes();
          var s = date.getSeconds();

          return '' + h + ':' + (m <= 9 ? '0' + m : m) + ':' + (s <= 9 ? '0' + s : s);
        }

        function convertTransportMean(transportType) {
          if (transportType == 'bus') {
            return 'Autobus';
          }

          if (transportType == 'tram') {
            return 'Tramwaj';
          }
        }
    </script>
    
  </head>
  <body>
    <div data-role="page" id="home" style="width:100%; height:100%;" >

      <div data-role="header">
          <h2>Antykanar</h2>
          <a href="#" id="refresh_btn" data-icon="refresh" class="ui-btn-left"><h1></h1></a>
      </div>
      <div data-role="content" style="width:100%; height:100%; padding: 0px;" >
          <form>
              <fieldset data-role="collapsible" data-theme="a" data-content-theme="d">
                  <legend>Zgłoś</legend>
                  <label for="mean">Środek transportu:</label>
                  <select name="mean" id="mean" data-iconpos="left">
                      <option value="bus">Autobus</option>
                      <option value="tram">Tramwaj</option>
                  </select>
                  <div id="numbers-div" class="show-hide" >
                    <label for="numbers">Numer</label>
                    <select name="numbers" id="numbers" data-iconpos="left">
                    </select>
                  </div>
                  <div id="add-inspection-div" class="show-hide">
                    <a href="#" id="add-inspection" data-role="button">Dodaj</a>
                    <!-- <input type="submit" value="Dodaj" /> -->
                  </div>
              </fieldset>
          </form>
         <div class="item rounded dark">
           <div id="map_canvas" style="width:100%; height: 100%; min-height:318px;"></div>
         </div> 
      </div>
    </div>
  </body>
</html>