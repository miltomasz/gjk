<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /> -->

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    <style type="text/css">
      .show-hide {
        display:none;
      }

      .item {
          margin: 0px 2px 2px 2px;
          padding: 0px;
      }

      .rounded {
          border-radius: 8px 8px 8px 8px;
      }

      .dark {
          background: none repeat scroll 0 0 #2A3333;
      }

      .ui-collapsible-heading {
        display: block;
        font-size: 16px;
        /*margin: 0 -15px;*/
        padding: 2px;
        position: relative;
      }

      .ui-collapsible-content {
        background-image: none;
       /* border-left-width: 0;
        border-right-width: 0;*/
        border-top: 0 none;
        /*display: block;*/
        margin: -2px 2px 2px 2px;
        padding: 10px 15px;
      }

      .ui-collapsible-inset .ui-collapsible-content {
          border-left-width: 1px;
          border-right-width: 1px;
          margin: -2px 2px 2px 2px;
      }

    </style>
    
    
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <script type="text/javascript" src="jquery.ui.map.js"></script>
    <script type="text/javascript" src="jquery.ui.map.extensions.js"></script>
    <script type="text/javascript" src="modernizr.custom.22580.js"></script>
    <script type="text/javascript" >
      var AUTOBUSES = [101,102,103,104,105,107,108,109,110,111,112,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,138,139,140,141,142,143,145,146,147,148,149,151,152,153,154,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,201,202,203,204,205,206,207,208,209,210,211,212,213,215,216,217,218,219,220,222,225,226,227,228,245,300,302,303,304,305,306,311,314,315,317,318,319,326,331,338,345,365,394,401,409,410,411,414,422,426,444,460,500,501,502,503,504,507,509,510,511,512,514,516,517,519,520,521,523,525,527,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,727,728,729,730,731,732,733,734,735,736,738,739,740,741,742, 800,805,807,'E-2','E-4','E-6','E-8', 'L-1', 'L-2','L-3','L-4','L-5','L-6','L-7','L-8','L-9','L10','L11','L13','L14','L15','L16','L17','L18','L19'];

      var NIGHT_AUTOBUSES = ['N01','N02','N03','N11','N12','N13','N14','N21','N22','N24','N25','N31','N32','N33','N34','N35','N36','N37','N38','N41','N42','N43','N44','N45','N46','N50','N52','N56', 'N58','N61','N62','N63','N64','N71','N72','N75','N81','N83','N85','N88','N91','N95'];

      var TRAMS = [1,2,3,4,6,7,8,9,10,14,15,17,18,20,22,23,24,25,26,31,33,35,37,41,75,76,78];
      var SKM = ['S1','S2','S3','S9'];
      var WKD = ['Z-6','Z-9','Z17','ZS1'];

      var lat;
      var lng;
      var markers = [];

      $(function() {
          loadData();

          var options = '';
          var numbers = AUTOBUSES;

          for(var i = 0; i < numbers.length; i++) {
              options += '<option value="' + numbers[i] + '">' + numbers[i] + '</option>';
          }
              
          $("#numbers").html(options).selectmenu('refresh', true);;


          $("#refresh_btn").click(function() {
            loadData();
            location.reload(true);
          });

          $("#mean").change(function() {
              var meanOption = $(this).val();
              var numbers = []

              if(meanOption == 'bus') {
                  numbers = AUTOBUSES;
              }

              if(meanOption == 'tram') {
                  numbers = TRAMS;
              }

              if(meanOption == 'night_bus') {
                  numbers = NIGHT_AUTOBUSES;
              }

              if(meanOption == 'skm') {
                  numbers = SKM;
              }

              if(meanOption == 'wkd') {
                  numbers = WKD;
              }

              var options = '';
              for(var i = 0; i < numbers.length; i++) {
                  options += '<option value="' + numbers[i] + '">' + numbers[i] + '</option>';
              }
              
              $("#numbers").html(options).selectmenu('refresh', true);;
          });

          $('#home').on('pageshow', function (event, ui) {
              // loadData();
              // location.reload(true);
          });
 

          $("#add-inspection").click(function() {
            var form = $(this).closest("form");
            var transportType = form.find('select[name="mean"]').val();
            var number = form.find('select[name="numbers"]').val();

            $.post('/events', { "event" : { "transport_type" : transportType, "lat" : lat, "lng" : lng, "line_number": number }}, function(json) {
              
              loadData();
              location.reload(true);
              showMessage('Kontrola została zgłoszona!');
            });
          });

          $("#notesForm").submit(function(event) {
            event.preventDefault();

            var $form = $(this),
            note = $form.find('textarea[name="note"]').val();

            if (note.length == 0) {
              return false;
            }

            $.ajax({
                url: '/notes/create', //sumbits it to the given url of the form
                type: 'POST' ,
                data: { "note" : {"content" : note }}
            }).success(function(json){
              loadData();
              location.reload(true);
              showMessage('Dziękujemy za uwagi!');
            });
          });

        });

        function loadData() {
          // start loading
          $.mobile.loading( 'show' );
          
          $('#map_canvas').gmap().bind('init', function(evt, map) {
            $('#map_canvas').gmap('getCurrentPosition', function(position, status) {
              if ( status === 'OK' ) {
                lat = position.coords.latitude;
                lng = position.coords.longitude;

                var clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                $('#map_canvas').gmap('addMarker', {'position': clientPosition, 'bounds': true});

                $.getJSON("/events?lat=" + lat + "&lng=" + lng, function(json) {
                    $.each(json, function(i, event) {
                      var imageType = selectImage(json[i].event.transport_type);

                      $('#map_canvas').gmap('addMarker', { 
                        'position': new google.maps.LatLng(json[i].event.lat, json[i].event.lng), 
                        'bounds': true,
                        'icon': 'images/' + imageType
                      }).click(function() {
                        var d = new Date(json[i].event.created_at);
                        var contentString = '<font size=\'2\'>Kontrola biletów:</font></br>' +
                                            ''+ convertTransportMean(json[i].event.transport_type) + 
                                            ', linia nr ' + json[i].event.line_number + '</br>' +
                                            'Godz. <b>' + timeToHMS(d) + '</b>';

                        $('#map_canvas').gmap('openInfoWindow', { 'content': contentString }, this);
                      });

                    });
                });
              }
              
              // stop loading
              $.mobile.loading( 'hide' );

              
            }); 

            
          });
          
        }

        function showMessage(text) {
          $("<div class='ui-loader ui-overlay-shadow ui-body-e ui-corner-all'>" +
              "<h3>" + text + "</h3>" +
            "</div>").css({ "display": "block", "opacity": 0.96, "left": 10, "right": 10, "top": $(window).scrollTop() + 100})
          .appendTo( $.mobile.pageContainer )
          .delay( 1500 )
          .fadeOut( 400, function(){
            $(this).remove();
          });
        }

        function dateToYMD(date) {
            var d = date.getDate();
            var m = date.getMonth() + 1;
            var y = date.getFullYear();

            return '' + y + '-' + (m <= 9 ? '0' + m : m) + '-' + (d <= 9 ? '0' + d : d);
        }

        function timeToHMS(date) {
          var h = date.getHours();
          var m = date.getMinutes();
          var s = date.getSeconds();

          return '' + h + ':' + (m <= 9 ? '0' + m : m) + ':' + (s <= 9 ? '0' + s : s);
        }

        function selectImage(transportType) {
          if (transportType == 'bus' || transportType == 'night_bus') {
            return 'bus.png';
          }

          if (transportType == 'tram') {
            return 'tram.png';
          }

          return 'train.png';
        }

        function convertTransportMean(transportType) {
          if (transportType == 'bus') {
            return 'Autobus';
          }

          if (transportType == 'tram') {
            return 'Tramwaj';
          }

          if (transportType == 'night_bus') {
            return 'Autobus nocny';
          }

          if (transportType == 'wkd') {
            return 'WKD';
          }

          if (transportType == 'skm') {
            return 'SKM';
          }
        }
    </script>
    
  </head>
  <body>
    <div data-role="page" id="home" style="width:100%; height:100%;" data-url="/">

      <div data-role="header" data-theme="e">
          <h2>Antykanar</h2>
          <a href="#" id="refresh_btn" data-icon="refresh" class="ui-btn-left show-page-loading-msg" data-iconpos="notext" 
           data-textonly="false" data-textvisible="false" data-msgtext="" data-inline="true"></a>
          <a href="#notes" id="notes_btn" data-icon="edit" class="ui-btn-right" data-iconpos="notext"></a>
      </div>
      <div data-role="content" style="width:100%; height:100%; padding: 0px;" >
          <form>
              <fieldset data-role="collapsible" data-theme="d" data-content-theme="d">
                  <legend>Zgłoś kontrolę</legend>
                  <label for="mean">Środek transportu:</label>
                  <select name="mean" id="mean" data-iconpos="left">
                      <option value="bus">Autobus</option>
                      <option value="night_bus">Autobus nocny</option>
                      <option value="tram">Tramwaj</option>
                      <option value="skm">SKM</option>
                      <option value="wkd">WKD</option>
                  </select>
                  <!-- <div id="numbers-div" class="show-hide" > -->
                    <label for="numbers">Numer:</label>
                    <select name="numbers" id="numbers" data-iconpos="left">
                    </select>
                  <!-- </div> -->
                  <!-- <div id="add-inspection-div" class="show-hide"> -->
                    <a href="#" id="add-inspection" data-role="button">Dodaj</a>
                    <!-- <input type="submit" value="Dodaj" /> -->
                  <!-- </div> -->
              </fieldset>
          </form>
         <div class="item rounded dark">
           <div id="map_canvas" style="width:100%; height: 100%; min-height:318px;"></div>
         </div> 
      </div>
    </div>

    <!-- Start of second page -->
    <div data-role="page" id="notes" style="width:100%; height:100%;" >

      <div data-role="header" data-theme="e">
          <h2>Antykanar</h2>
          <a href="#home" id="back_btn" data-icon="back" class="ui-btn-left" data-iconpos="notext" ></a>
      </div>

      <div data-role="content">
        <form id="notesForm" >
            <label for="textarea-1">Antykanar jest w wersji beta! Czekamy na uwagi:</label>
            <textarea cols="40" rows="30" name="note" id="textarea-1" required></textarea>
            <input type="submit" value="Wyślij" >
        </form>
      </div><!-- /content -->

    </div><!-- /page -->
  </body>
</html>