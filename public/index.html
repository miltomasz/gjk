<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /> -->

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    <style type="text/css">
      .show-hide {
        display:none;
      }

      .item {
          margin: 0px 2px 2px 2px;
          padding: 0px;
      }

      .rounded {
          border-radius: 8px 8px 8px 8px;
      }

      .dark {
          background: none repeat scroll 0 0 #2A3333;
      }

      .ui-collapsible-heading {
        display: block;
        font-size: 16px;
        /*margin: 0 -15px;*/
        padding: 2px;
        position: relative;
      }

      .ui-collapsible-content {
        background-image: none;
       /* border-left-width: 0;
        border-right-width: 0;*/
        border-top: 0 none;
        /*display: block;*/
        margin: -2px 2px 2px 2px;
        padding: 10px 15px;
      }

      .ui-collapsible-inset .ui-collapsible-content {
          border-left-width: 1px;
          border-right-width: 1px;
          margin: -2px 2px 2px 2px;
      }

    </style>
    
    
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <script type="text/javascript" src="jquery.ui.map.js"></script>
    <script type="text/javascript" src="jquery.ui.map.extensions.js"></script>
    <script type="text/javascript" src="modernizr.custom.22580.js"></script>
    <script src="assets/javascripts/src/antykanar.js"></script>
    <script src="assets/javascripts/src/transportData.js"></script>
    <script type="text/javascript" >
      var lat;
      var lng;
      var markers = [];

      $(function() {
          loadData();

          var optionsCreator = new OptionsCreator(AUTOBUSES);

          $("#numbers").html(optionsCreator.options()).selectmenu('refresh', true);

          $("#refresh_btn").click(function() {
            loadData();
            location.reload(true);
          });

          $("#mean").change(function() {
              var meanOption = $(this).val();
              
              optionsCreator.changeTo(meanOption);
              
              $("#numbers").html(optionsCreator.options()).selectmenu('refresh', true);;
          });

          $("#add-inspection").click(function() {
            var form = $(this).closest("form");
            var transportType = form.find('select[name="mean"]').val();
            var number = form.find('select[name="numbers"]').val();

            $.post('/events', { "event" : { "transport_type" : transportType, "lat" : lat, "lng" : lng, "line_number": number }}, function(json) {
              
              loadData();
              location.reload(true);
              showMessage('Kontrola została zgłoszona!');
            });
          });

          $("#notesForm").submit(function(event) {
            event.preventDefault();

            var $form = $(this),
            note = $form.find('textarea[name="note"]').val();

            if (note.length == 0) {
              return false;
            }

            $.ajax({ 
                url: '/notes/create', 
                type: 'POST', 
                data: { "note" : {"content" : note }}
            }).success(function(json){
              loadData();
              location.reload(true);
            });
          });

          if ($.urlParam("showMessage")) {
            if ($.urlParam("showMessage") == 'note') {
              showMessage("Dziękujemy za uwagi!");
              window.location.replace("/");
            }
          }
        });

        function loadData() {
          // start loading
          $.mobile.loading( 'show' );
          
          $('#map_canvas').gmap().bind('init', function(evt, map) {
            $('#map_canvas').gmap('getCurrentPosition', function(position, status) {
              if ( status === 'OK' ) {
                lat = position.coords.latitude;
                lng = position.coords.longitude;

                var clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                $('#map_canvas').gmap('addMarker', {'position': clientPosition, 'bounds': true});

                $.getJSON("/events?lat=" + lat + "&lng=" + lng, function(json) {
                    $.each(json, function(i, event) {
                      var imageType = new TransportMapper().getFileExt(json[i].event.transport_type);

                      $('#map_canvas').gmap('addMarker', { 
                        'position': new google.maps.LatLng(json[i].event.lat, json[i].event.lng), 
                        'bounds': true,
                        'icon': 'images/' + imageType
                      }).click(function() {
                        var transportName = new TransportMapper().convert(json[i].event.transport_type);
                        var lineNumber = json[i].event.line_number;
                        var date = new DateBuilder(json[i].event.created_at);

                        var contentString = '<font size=\'2\'>Kontrola biletów:</font></br>' + transportName + 
                                            ', linia nr ' + lineNumber + '</br>' +
                                            'Godz. <b>' + date.toHMS() + '</b>';

                        $('#map_canvas').gmap('openInfoWindow', { 'content': contentString }, this);
                      });

                    });
                });
              }
              
              // stop loading
              $.mobile.loading( 'hide' );
            }); 
          });

        }

        $.urlParam = function(name){
            var results = new RegExp('[\\?&amp;]' + name + '=([^&amp;#]*)').exec(window.location.href);
            if (results == null) {
              return 0;
            }
            return results[1];
        }

        function showMessage(text) {
          $("<div class='ui-loader ui-overlay-shadow ui-body-e ui-corner-all'>" +
              "<h3>" + text + "</h3>" +
            "</div>").css({ "display": "block", "opacity": 0.96, "left": 10, "right": 10, "top": $(window).scrollTop() + 100})
          .appendTo( $.mobile.pageContainer )
          .delay( 1500 )
          .fadeOut( 1500, function(){
            $(this).remove();
          });
        }

    </script>
    
  </head>
  <body>
    <div data-role="page" id="home" style="width:100%; height:100%;" >

      <div data-role="header" data-theme="e">
          <h2>Antykanar</h2>
          <a href="#" id="refresh_btn" data-icon="refresh" class="ui-btn-left show-page-loading-msg" data-iconpos="notext" 
           data-textonly="false" data-textvisible="false" data-msgtext="" data-inline="true"></a>
          <a href="note.html" id="notes_btn" data-icon="edit" class="ui-btn-right" data-iconpos="notext" data-ajax="false"></a>
      </div>
      <div data-role="content" style="width:100%; height:100%; padding: 0px;" >
          <form>
              <fieldset data-role="collapsible" data-theme="d" data-content-theme="d">
                  <legend>Zgłoś kontrolę</legend>
                  <label for="mean">Środek transportu:</label>
                  <select name="mean" id="mean" data-iconpos="left">
                      <option value="bus">Autobus</option>
                      <option value="night_bus">Autobus nocny</option>
                      <option value="tram">Tramwaj</option>
                      <option value="skm">SKM</option>
                      <option value="wkd">WKD</option>
                  </select>
                  <!-- <div id="numbers-div" class="show-hide" > -->
                    <label for="numbers">Numer:</label>
                    <select name="numbers" id="numbers" data-iconpos="left">
                    </select>
                  <!-- </div> -->
                  <!-- <div id="add-inspection-div" class="show-hide"> -->
                    <a href="#" id="add-inspection" data-role="button">Dodaj</a>
                    <!-- <input type="submit" value="Dodaj" /> -->
                  <!-- </div> -->
              </fieldset>
          </form>
         <div class="item rounded dark">
           <div id="map_canvas" style="width:100%; height: 100%; min-height:318px;"></div>
         </div> 
      </div>
    </div>

  </body>
</html>